<html>
<head>
<link rel="shortcut icon" type="image/png" href="img/star-ico.png?"/>
<meta http-equiv="Content-Language" content="zh-tw">
<meta charset="UTF-8">
<title>紫微斗數</title>
<link rel="stylesheet" type="text/css" href="js/ziwei.css">
<script src="js/lunar.js" type="text/javascript"></script>
<script src="js/ziweistar.js" type="text/javascript"></script>
<script src="js/ziweicore.js" type="text/javascript"></script>
<script src="js/ziweiui.js" type="text/javascript"></script>
</head>
<body>
	<div class="zwDivHeader">
		<h2>紫微斗數排盤</h2>
		<div>
			西元 <select id="sel_Year"></select> 年
			<select id="sel_Month"></select> 月
			<select id="sel_Day"></select> 日
			<select id="sel_Hour"></select> 時
			<input type="radio" name="gender" value="M" checked>男
			<input type="radio" name="gender" value="F">女
			<input type="button" id="btn-gen" value="排盤">
		</div>
	</div>
	<div class="zwDivHeader">
		<h2>基本資訊</h2>
	</div>
	
	<div class="zwDivHeader">
		<h2>主星的分析</h2>
	</div>	
	<table id="analysis" border="0" style="width:100%;margin-top:20px;">
		<tr>
			<td>A. 命宮與福德宮主星的基本分析。</td>
		</tr>			
		<tr>
			<td id="mingfu-analysis" style="padding-left:20px;"></td>
		</tr>
		<tr>
			<td>B. 四化星分析。</td>
		</tr>
		<tr>
			<td>C. 命宮三方四正總格局分析。</td>
		</tr>
		<tr>
			<td>D. 命宮三方四正六吉星和六煞星分析。</td>
		</tr>
		<tr>
			<td>E. 紫微斗數的特殊格局分析。</td>
		</tr>
		<tr>
			<td>F. 工作能力分析。</td>
		</tr>
		<tr>
			<td>G. 貼心小建議。</td>
		</tr>
	</table>

	<div class="zwDivHeader">
		<br>
		<h2>主星的分布</h2>
	</div>
	<table id="star-table" class="ziwei-table">
		<thead>
			<tr>
				<th>天干地支</th>
				<th>十二宮</th>
				<th>主星</th>
				<th>四化星</th>
				<th>六吉星</th>
				<th>六凶星</th>
				<th>輔助星</th>
			</tr>
		</thead>
		<tbody id="star-table-body">
		</tbody>
	</table>

	<div id="container"></div>
	<div id="star-analysis-text" style="display:none;">
		【命宮】紫微：領導格局強，自尊心高...
		【命宮】天機：聰明靈活反應快...
	</div>

	<script>

	// 等待所有JS載入完成
	document.addEventListener('DOMContentLoaded', function() {
		// 命宮與福德宮分析數據
		console.log('開始獲取命宮福德宮分析...');
		// 監聽排盤按鈕點擊
		document.getElementById('btn-gen').addEventListener('click', async function() {
			const btn = this;
			const originalText = btn.value;
			
			console.log('排盤按鈕點擊');
			try {
				btn.disabled = true;
				btn.value = '排盤中...';
				
				if (typeof ziweiUI === 'undefined' || !ziweiUI.genZiwei) {
					throw new Error('ziweiUI 未正確載入');
				}

				console.log('開始排盤...');
				const isSuccess = await ziweiUI.genZiwei();
				
				if (!isSuccess) {
					throw new Error('排盤失敗');
				}

				console.log('排盤完成，開始分析命宮福德宮...');
				await updateMingFuAnalysis();
				console.log('命宮福德宮分析完成');
			} catch (error) {
				console.error('排盤過程中出錯:', error);
				alert('排盤失敗: ' + error.message);
			} finally {
				btn.disabled = false;
				btn.value = originalText;
			}
		});
		console.log('排盤按鈕事件監聽器已設定');
		// 命宮與福德宮主星分析
		async function updateMingFuAnalysis() {
			try {
				console.log('開始獲取命宮福德宮主星...');
				const starTable = document.getElementById('star-table-body');
				if (!starTable) {
					console.warn('找不到星盤表格');
					return;
				}

				// 檢查星盤表格是否已載入內容
				if (starTable.innerHTML.trim() === '') {
					console.warn('星盤表格內容為空，請先完成排盤');
					return;
				}

				// 獲取命宮行 (透過名稱查詢)
				const mingRow = Array.from(starTable.querySelectorAll('tr')).find(tr => {
					try {
						return tr.querySelector('td:nth-child(2)')?.textContent?.includes('命宮');
					} catch (e) {
						console.error('查詢命宮行時出錯:', e);
						return false;
					}
				});

				// 獲取福德宮行 (透過名稱查詢)
				const fuRow = Array.from(starTable.querySelectorAll('tr')).find(tr => {
					try {
						return tr.querySelector('td:nth-child(2)')?.textContent?.includes('福德宮');
					} catch (e) {
						console.error('查詢福德宮行時出錯:', e);
						return false;
					}
				});

				if (!mingRow || !fuRow) {
					console.warn('找不到命宮或福德宮行');
					return;
				}

				let mingStar, fuStar;
				try {
					mingStar = mingRow.querySelector('td:nth-child(3)')?.textContent?.trim();
					fuStar = fuRow.querySelector('td:nth-child(3)')?.textContent?.trim();
				} catch (e) {
					console.error('獲取主星名稱時出錯:', e);
					return;
				}

				console.log('命宮主星:', mingStar);
				console.log('福德宮主星:', fuStar);

				if (!mingStar || !fuStar) {
					console.warn('無法獲取命宮或福德宮主星，請確認排盤已完成');
					return;
				}

				let analysis = '<div class="star-analysis-container">';
				
				// 從API獲取命宮分析
				const mingAnalysis = await getStarAnalysis(mingStar, '命宮');
				analysis += `
					<div class="star-analysis-section">
						<h3>命宮(${mingStar})基本分析</h3>
						<div class="star-analysis-content">${mingAnalysis}</div>
					</div>
				`;
				
				// 從API獲取福德宮分析
				console.log('開始獲取福德宮分析，主星:', fuStar);
				const fuAnalysis = await getStarAnalysis(fuStar, '福德宮');
				console.log('福德宮分析結果:', fuAnalysis);
				analysis += `
					<div class="star-analysis-section">
						<h3>福德宮(${fuStar})基本分析</h3>
						<div class="star-analysis-content">${fuAnalysis}</div>
					</div>
				`;
				
				analysis += '</div>'; // 關閉容器
				const analysisDiv = document.getElementById('mingfu-analysis');
				if (analysisDiv) {
					console.log('找到 mingfu-analysis div, 更新內容:', analysis);
					analysisDiv.innerHTML = analysis;
				} else {
					console.error('找不到 mingfu-analysis div');
				}
			} catch (error) {
				console.error('更新命宮福德宮分析時出錯:', error);
			}
		}

		console.log('開始載入主星分布表格...');
		// 從數據庫API獲取主星分析
		async function getStarAnalysis(starName, palaceName) {
			// 參數驗證
			console.log('開始驗證參數:', {starName, palaceName});
			if (!starName || typeof starName !== 'string' || !palaceName || typeof palaceName !== 'string') {
				console.error('無效的參數:', {starName, palaceName});
				return '無效的主星或宮位名稱';
			}

			const controller = new AbortController();
			const timeoutId = setTimeout(() => {
				console.warn(`獲取 ${starName}(${palaceName}) 分析資料超時`);
				controller.abort();
			}, 5000);

			try {
				console.log(`開始獲取 ${starName}(${palaceName}) 分析資料...`);
				const apiUrl = `/api/star-analysis?star=${encodeURIComponent(starName)}&palace=${encodeURIComponent(palaceName)}`;
				console.debug('API URL:', apiUrl);

				const response = await fetch(apiUrl, {
					signal: controller.signal,
					headers: {
						'Content-Type': 'application/json',
						'Accept': 'application/json'
					},
					cache: 'no-store' // 避免快取問題
				});

				if (!response.ok) {
					const errorText = await response.text();
					console.error(`API 請求失敗 (${response.status}):`, errorText);
					throw new Error(`API 請求失敗: ${response.status} - ${errorText}`);
				}

				const data = await response.json();
				console.debug(`成功獲取 ${starName}(${palaceName}) 分析資料:`, data);
				
				// 驗證回應資料格式
				if (!data || typeof data !== 'object' || !('analysis' in data)) {
					console.error('無效的API回應格式:', data);
					return '無效的分析資料格式';
				}
				
				return data.analysis || '暫無此主星的分析資料';
			} catch (error) {
				if (error.name === 'AbortError') {
					console.error(`獲取 ${starName}(${palaceName}) 分析資料超時`);
					return '請求超時，請稍後再試';
				}
				console.error(`獲取 ${starName}(${palaceName}) 分析資料時出錯:`, error);
				return '獲取分析資料時發生錯誤';
			} finally {
				clearTimeout(timeoutId);
				console.log(`完成 ${starName}(${palaceName}) 分析資料請求處理`);
			}
		}
	});
	</script>
</body>
</html>
